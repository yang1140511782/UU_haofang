var app = getApp();
var api = require('../../utils/common.js');
import { Tools } from '../../utils/tools';
const tool = new Tools();
var myJson = {};
Page({
    data: {
      shareInfoFlag:false,//经纪人个人微店 进入 及 掌通分享 : 新房显示
      animationData: {},
      showFlas: true,
      offFlag: false,
        toastHide: true,
        caseId: 0,
        caseType: 1,
        cityId: null,
        reSource: 1,
        fromDetail:'',
        picUrl: [],//房源图片数组
        videoUrlPath: '',//视频地址
        videoTopPicUrlPath: '',//视频预览图片地址,
        houseSubject: '',
        tagArr: [],//房源标签
        isCollected: 0,//收藏五角星的显示状态，1是收藏，0是未收藏
        agentCont: false,//控制咨询经纪人显示
        allAgentCont: false,//控制群发委托显示
        yezhuCont: false,//控制咨询业主显示
        hezu:false,
        indicatorDots: false,//swiper是否显示面板指示点
        autoplay: false,//自动切换
        loadingFlag:true,
        interval: 5000,
        duration: 500,
        currentPic: 1,
        totalPics: 0,
        imId:'',
        houseSubject: '',
        houseTotalPrice: '',
        unitPrice: '',
        priceUnitCn: '',
        houseUseage:'',
        houseUseageCn: '',
        totalPrice: '',
        houseArea: '',
        houseRoom: '0',
        houseHall: '0',
        houseWei: '0',
        buildType:'--',
        houseFitment:'',
        houseFitmentCn: '--',
        houseDirectCn: '--',
        houseYear: '--',
        houseFloor: '--',
        houseFloors: '--',
        buildName: '',
        rightYears: '--',
        costStandard: '--',
        projectGreen: '--',
        projectSpace: '--',
        submitDate: '--',
        builder: '--',
        propertyComp: '--',
        buildDescript: '--',
        hasPullDown: false,
        busLine: '--',
        addCase: '--',
        houseList: [],
        buildPositionx: 0,
        buildPositiony: 0,
        panoramaMap:0,
        panoramaThumbUrl:'',
        _top:0,
        _left:0,
        vrUrl:'',
        vrIconShow:false,
        videoPhoto: 'btn-video',
        picFlag: false,
        trueFlag:0,
        imgLists: [],//轮播图路径
        totalImg: 0,//轮播图总张数
        sealedHouse:false,//房源下架弹框控制显示
        toastMask:false,//弹框外层
        guideToast:false,//引导弹框
        leadToast:false,//引导弹框显示控制
        footerNav:false,//底部
        lazyLoad:true,
        discountStatus:false,//折扣弹框
        userPhone:'',//用户电话
        collectToast:false,//收藏
        collectTxt:"",//收藏提示
        is400Mobile:0,
        cursorUrl:'../../images/detail/cursor.png',
        map: {
            lat: 0,
            lng: 0,
            markers: [],
            hasMarkers: false
        },
        closeCont: false,//小区信息展开控制
        houseShowTitle: true, //小区信息查看更多文章更换
        closepic: false,
        footerShow: false,
        videoShowLater: false,
        autoplay:false,
        boxShow: true,//外层盒子
        shareUrl: '',
        showmor: true,
        showtitle: true,
        showmorZb: true,//周边信息
        showtitleZb: true,//周边信息
        zbShowTitle: true, //周边信息查看更多文章更换
        zbClosepic: false,//周边
        lookMoreHide: true,//查看更多隐藏
        lookMoreZbHide: true,//周边查看更多隐藏
        wHeight:'',//屏幕高度
        toView:'aaa',
        scrollTop:100,
        morejt: 'https://uuweb.haofang.net/Public/wxApp/images/index/l-jtt.png',
        btnHiden: true,
        currUserMobile:'',
        currUserName:'',
        currUserPhotoUrlPath:'http://uuweb.haofang.net/Public/wxApp/images/detail/fang_default.png',
        //小区专家相关
        buildOwnerArchiveId:'',
        buildOwnerName:'',
        buildOwnerPicUrl:'http://uuweb.haofang.net/Public/wxApp/images/detail/fang_default.png',
        buildOwnerMobile:'',
        buyMoney:"",
        rentMoney:"",
        serviceRegs:"",
        buildIntegrity:0,
        buildOwnerHouseList:[],
        gpBrokerList:[],//挂牌经纪人数组,
        gpBrokerCount:'',//挂牌经纪人数
        ownerName:'',
        setting:[],
        archiveId:'',
        buildRegionId: '',
        sectionId: '',
        regionName: '',
        sectionName: '',
        recomInfoId:'',
        userId:'',//
        isVip:'',
        showKanFang:false,
        isOwner:false,
        evaluateValue:'',//房价评估数据
        ratioByLastMonthForPrice:'',
        ratioByLastYearForPrice:'',
        AgentUserId:'',//经纪人ID
        buildId:'',
        imId:'',
        openHuabei:0,
        yezhuContactFlag:false,
        shareArchiveId:'',
        animationCloudData:'',
        typeList: {
          '公交': { typeId: 'bus', typeName: '公交' },
          '地铁': { typeId: 'subway', typeName: '地铁' },
          '学校': { typeId: 'school', typeName: '学校' },
          '医院': { typeId: 'hospital', typeName: '医院' },
          '银行': { typeId: 'bank', typeName: '银行' },
          '休闲娱乐': { typeId: 'leisure', typeName: '休闲娱乐' },
          '购物': { typeId: 'shopping', typeName: '购物' },
          '餐饮': { typeId: 'food', typeName: '餐饮' },
          '运动健身': { typeId: 'sports', typeName: '运动健身' },
        },
        serviceArchiveId:app.globalData.imService,
        communityToast:false,
        wWidth:'',
        videoHeight:'',
        shareOpenId:'',//分享人openId
        backToIndexBtn:false,
        surroudMore: false,
        describeHouse: false,
        lessContent:true,
        guideBackIndex:true
    },
    videoPhotoChange: function (e) {
        var currentBtn = this.data.videoPhoto == 'btn-video' ? 'btn-photo' : 'btn-video';
        var picFlag = this.data.picFlag ? false : true;
        this.setData({
            videoPhoto: currentBtn,
            picFlag: picFlag
        });
    },
    //查看全部
    lookMoreFeature() {
      var that = this;
      var boo = !that.data.lessContent,
        zbShowss = !that.data.showmorZb,
        zbShowtt = !that.data.showtitleZb,
        zbClosess = !that.data.zbClosepic;
      that.setData({
        showmorZb: zbShowss,
        showtitleZb: zbShowtt,
        zbClosepic: zbClosess,
        lessContent: boo
        // btnHiden:false
      });
    },
    /**
   * 点击蒙层,关闭弹框
   */
    closeToastBox() {
      this.setData({
        toastHide: true
      });
    },
    /**
     *  阻止冒泡
     */
    cancelBubble() {
      return false;
    },

    /**
     * 同意切换到定位城市
     */
    changeCity: function () {
      this.setData({ toastHide: true });
      if(this.data.locateCityId>0){
      	wx.setStorageSync('cityId', this.data.locateCityId);
          wx.setStorageSync('cityName', this.data.locateCityName);
          wx.reLaunch({
              url: "/pages/real_index/index"
            });
      }else{
          wx.reLaunch({
  	        url: "/pages/chooseCity/chooseCity"
  	    });
      }
    },
    onLoad: function (options) {
      //获取当前页面层级
      var getCurrentPagesLength = getCurrentPages().length;
      if(getCurrentPagesLength == 1){
        //如果分享出来的详情页为首页,则展示首页按钮
        this.setData({backToIndexBtn:true});
      }
      var _this = this;
      var curCityId = wx.getStorageSync('cityId');
      //更新城市
      _this.setData({
        cityId: curCityId
      });
      _this.setData({
        userMobile: wx.getStorageSync('userMobile'),
        locateCityName: wx.getStorageSync('locateCityName'),
        locateCityId: wx.getStorageSync('locateCityId')
      });
      var userId=wx.getStorageSync('userId');
      if (options.source == 'uuapp'||options.source == 'zshft') {
        if(options.activity == 1){
        	wx.setStorageSync('shareArchiveId',options.archive_id);
        	wx.setStorageSync('shareCaseType',options.casetype);
        	wx.setStorageSync('shareCityId',options.cityid);
        	wx.setStorageSync('shareCaseId',options.caseid);
        }
        
        this.setData({
          shareArchiveId:options.archive_id
        });
      };
      if(!wx.getStorageSync('openId')){
    	  app.saveUserData();
      }
      var scene = options.scene;
      if(!!scene){
    	  scene = decodeURIComponent(scene).split("&");
    	  options.caseType = scene[0];
    	  options.resource = scene[1];
    	  options.cityId = scene[2];
    	  options.caseId = scene[3];
      }
      
      /*个人微店进入详情和掌通分享进入详情,不展示周边新房及小区专家*/
      if (options.source == 'personalStore' || options.source == 'zshft') {
        this.setData({
          shareInfoFlag:true
        });
      };
      
      wx.getSystemInfo({
        success: function (res) {
          _this.setData({
            wHeight: res.windowHeight -50,
            wWidth: res.windowWidth
          })
        }
      })
      _this.setData({
        videoHeight: _this.data.wWidth*0.75
      })
      _this.setData({ userPhone: wx.getStorageSync('userMobile') });
       var setDa = { userId:userId,caseId: options.caseId||options.caseid, caseType: options.caseType||options.casetype, cityId: options.cityId||options.cityid, reSource: options.reSource||options.resource};
       if(options.fromDetail||options.fromdetail){
    	   setDa['fromDetail'] = options.fromDetail||options.fromdetail;
       }
       if(options.shareOpenId||options.shareopenid){
    	   setDa['shareOpenId'] = options.shareOpenId||options.shareopenid;
       }
       this.setData(setDa);
       if(options.recomInfoId && options.userId && options.isVip != undefined){
    	   this.setData({ recomInfoId: options.recomInfoId,userId:options.userId,isVip:options.isVip, showKanFang: true});
       }
      //出租
        this.initData();
     
      
    },
    initData: function () {//初始化页面数据
        var info = this.data;
        var that = this;
        wx.request({
            url: "https://uuhf.haofang.net/uuhfWeb/houseInfoManager/getHouseInfo?caseId=" + info.caseId + "&caseType=" + info.caseType + "&cityId=" + info.cityId + "&reSource=" + info.reSource+'&youyouUserId='+info.userId,
            success: function (res) {
                var isExist = res.data.DATA.houseIsExist;
                if (isExist != 1){
                	that.setData({
                    hasPullDown: true
                  });
                  return;
                };
               
                var info = res.data.DATA;
                myJson = info;
                var _agentUserID = info.userId;
                var picUrlArr = [], videoNum = 0;
                //如果登录人的ID是该条房源经纪人的ID则不显示底部
                if (_agentUserID == app.globalData.userId){
                    myJson['agentCont'] = false;
                    myJson['allAgentCont'] = false;
                    myJson['yezhuCont'] = false;
                    myJson['agentCont'] = false;
                    myJson['showKanFang'] = false;
                  }else{
                      that.setData({
                        footerNav: true
                    });
                  }
                if (!!info.photoList) {
                    var photoList = info.photoList;
                    for (var i = 0; i < photoList.length; i++) {
                        if (!!(photoList[i].picUrl)) {
                            picUrlArr.push(tool.addImgParam(photoList[i].picUrl,600,480));
                        }
                    }
                    myJson['picUrl'] = picUrlArr;
                }
                if (!!info.videoUrlPath) {
                    myJson['videoUrlPath'] = info.videoUrlPath;
                    myJson['videoTopPicUrlPath'] = info.videoTopPicUrlPath;
                    videoNum = 1;
                }
                myJson['totalImg'] = picUrlArr.length + videoNum;
                that.d(info, 'houseSubject');
                that.d(info, 'isCollected');
                that.d(info, 'houseTotalPrice');
                that.d(info, 'unitPrice');
                that.d(info, 'priceUnitCn');
                that.d(info, 'houseRoom');
                that.d(info, 'houseHall');
                that.d(info, 'houseWei');
                if ((!!info.houseArea) && info.houseArea > 0) {
                    myJson['houseArea'] = info.houseArea;
                };
                if (!!info.houseTagDesc) {
                    myJson['tagArr'] = info.houseTagDesc.split("|");
                };
                if (!!info.houseList) {
                	var houseList = info.houseList;
                	for (var i = 0; i < houseList.length; i++) {
                		houseList[i]['photoAddr'] = tool.addImgParamCrop(houseList[i]['photoAddr'],180,120);
					}
                	myJson['houseList'] = houseList;
                };
                if(info.houseDesc){
                  var describeHouse = decodeURIComponent(info.houseDesc);
                  describeHouse = describeHouse.replace(/\\r\\n/g,"\n");
                  myJson['houseDesc'] = describeHouse;
                  if (describeHouse.length > 50) {
                    that.setData({
                      describeHouse: true
                    });
                  };
                }
                if(info.buildDescript){
                	myJson['buildDescript'] = decodeURIComponent(info.buildDescript);
                }
                if(info.busLine){
                	myJson['busLine'] = decodeURIComponent(info.busLine);
                }
                if(info.addCase){
                  var addCase = decodeURIComponent(info.addCase);
                  myJson['addCase'] = addCase.replace(/\\r\\n/g,"\n");
                  if(addCase.length > 50){
                    that.setData({
                      surroudMore: true
                    });
                  };
                };
                wx.setNavigationBarTitle({
                  title: info.buildName
                });
                that.d(info, 'houseUseage');
                that.d(info, 'houseUseageCn');
                that.d(info, 'houseFitment');
                that.d(info, 'houseFitmentCn');
                that.d(info, 'houseDirectCn');
                that.d(info, 'houseYear');
                that.d(info, 'houseFloor');
                that.d(info, 'houseFloors');
                that.d(info, 'buildName');
                that.d(info, 'buildType');
                that.d(info, 'rightYears');
                that.d(info, 'costStandard');
                that.d(info, 'projectGreen');
                that.d(info, 'projectSpace');
                that.d(info, 'submitDate');
                that.d(info, 'builder');
                that.d(info, 'propertyComp');
                that.d(info, 'buildPositionx');
                that.d(info, 'buildPositiony');
                that.d(info, 'panoramaMap');
                that.d(info, 'trueFlag');
                that.d(info, 'currUserMobile');
                that.d(info, 'imId');
                that.d(info, 'currUserName');
            	that.d(info, 'currUserPhotoUrlPath');
                that.d(info, 'archiveId');
                that.d(info, 'buildOwnerArchiveId');
                that.d(info, 'buyMoney');
                that.d(info, 'rentMoney');
                that.d(info, 'serviceRegs');
                that.d(info, 'buildOwnerName');
            	that.d(info, 'buildOwnerPicUrl');
                that.d(info, 'buildOwnerMobile');
                that.d(info, 'buildIntegrity');
                that.d(info, 'buildOwnerHouseList');
                that.d(info, 'gpBrokerList');
                that.d(info, 'gpBrokerCount');
                that.d(info, 'ownerName');
                that.d(info, 'setting');
                that.d(info, 'buildRegionId');
                that.d(info, 'sectionId');
                that.d(info, 'regionName');
                that.d(info, 'sectionName');
                that.d(info, 'sectionName');
                that.d(info, 'buildId');
                that.d(info, 'imId');
                that.d(info, 'openHuabei');
                that.d(info, 'is400Mobile');
                that.d(info, 'isDecrypt');
                
                if(info.wxId && info.wxId == app.globalData.userId){
                	myJson['isOwner'] = true;
                }

                if(info.panoramaMap>0){
                	var vrUrl = 'https://pano.haofang.net/pano/pano720.jsp?CITY_ID='+that.data.cityId+'&CASE_TYPE='+that.data.caseType+'&CASE_ID='+that.data.caseId+'&APP_SOURCE=1&SOURCE=WEB&SSL=1';
                	if(info.shareArchiveId > 0){
                		vrUrl += "&ARCHIVE_ID="+that.data.shareArchiveId;
                	}
                	myJson['vrUrl'] = vrUrl;
                  
                  //获取VR首图
                  var panoramaThumbUrl = info.panoramaThumbUrl;
                   
                  if(!panoramaThumbUrl){
                    //如果 java接口还没添加 VR首图 则 请求php接口获取 VR首图
                    wx.request({
                        url: app.buildRequestUrl('getVRFirstPhotoUrl'),
                        data:{
                          caseId:that.data.caseId,
                          caseType:that.data.caseType,
                          cityId:that.data.cityId,
                        },
                        success: function (res) {
                        	if(res.data.STATUS == 1){
                        		var panoramaThumbUrl = res.data.DATA;
                            if(!!panoramaThumbUrl){
                              that.setData({panoramaThumbUrl:panoramaThumbUrl,vrIconShow:true});
                            }
                        	}
                        }
                    })
                  }else{
                    that.setData({panoramaThumbUrl:panoramaThumbUrl,vrIconShow:true});
                  }
                  
                  //如果有VR 初始化VR动画
                  var WIN_W = wx.getSystemInfoSync().windowWidth;
                   //换算盒子宽高 : 750:479.25
                  var WIN_H = WIN_W*480/750;
                  var _leftMax = WIN_W/2;
                  var _topMax = WIN_H/2;

                  wx.onAccelerometerChange(function (res) {

                      var _x = res.x.toFixed(2),            //横向 X 轴 -1 ~ 1
                          _y = res.y.toFixed(2),              //纵向 Y 轴 -1 ~ 1
                          _z = res.z.toFixed(2);              //纵向 Z 轴 -1 ~ 1

                      var _topOld = that.data._top;
                      var _leftOld = that.data._left;
                      var _top, _left;
                      var _top = (_y * _topMax) * (-1);      //
                      _left = (_x * _leftMax);
                     _left = _left > 0 ? (_left > _leftMax ? _leftMax : _left) : (_left < -_leftMax ? -_leftMax : _left);
                     _top = _top > 0 ? (_top > _topMax ? _topMax : _top) : (_top < -_topMax ? -_topMax : _top);

                   //只有在变化 不超过  一定范围才移动 , 防止剧烈抖动

                      //  _left = (_left - _leftOld)/_leftOld < 0.02?_left:_leftOld;
                     //  _top =  (_top - _topOld)/_topOld < 0.02?_top:_topOld;

                      that.setData({_top: _top,_left: _left,});


                   })

                  setTimeout(function() {
                    that.setData({vrIconShow:true});
                  }, 800);
                  //如果有VR图 , 则初始化VR动态

                }
                if(!!info.houseSetCn){
                	myJson['houseSetCn'] = info.houseSetCn.split("||");
                }
                // if (!that.data.houseDesc || that.data.houseDesc.length < 100) {
                // 	myJson['lookMoreHide'] = false;
                // }
                if (!that.data.addCase || that.data.addCase.length < 100) {
                    myJson['lookMoreZbHide'] = false;
                }
                var buildOwnerHouseList = that.data.buildOwnerHouseList;
                if(buildOwnerHouseList){
                	for(var i=0;i<buildOwnerHouseList.length;i++){
                		var desc = buildOwnerHouseList[i].houseTagDesc;
                		if(!!desc){
                			buildOwnerHouseList[i].houseTagDesc = desc.split("|");
                		}
                	}
                	myJson['buildOwnerHouseList'] = buildOwnerHouseList;
                }

                //判断底部按钮显示情况
                if(that.data.reSource==1 && myJson.trueFlag>0){//真房源
                	myJson['agentCont'] = true;//展示经纪人的联系方式
                }else if(that.data.reSource==1 && myJson.trueFlag==0){//20171208 段成伟 最新逻辑 普通ERP经纪人房源和搜搜经纪人房源展示挂牌经纪人同时联系方式展示小区专家的,如果没有小区专家那么展示客服的
                	myJson['allAgentCont'] = true;
                	myJson['gpBrokerCount'] = 4;
                }else if(that.data.reSource==2){//搜搜中介房源,也就是挂牌房源,展示挂牌经纪人
                	myJson['allAgentCont'] = true;
                }else if(that.data.reSource==3||that.data.reSource==4 && (!myJson.isOwner)){//搜搜个人和优优好房个人, 3和4一样展示房东和咨询业主按钮，点击咨询业主按钮，提示下载
                	myJson['yezhuCont'] = true;
                }else if(that.data.reSource==5){//搜搜合租 显示X先生/女士 和咨询业主电话，点击咨询业主直接拨打真实电话
                	myJson['hezu'] = true;
                }
                myJson['reSource'] = info.resource;
                that.setData(myJson);
                 //请求房价评估
                that.requstEvaluate();
                if(!!that.data.shareArchiveId){
                	wx.request({
                        url: app.buildRequestUrl('getBrokerInfo') + "?archiveId=" + that.data.shareArchiveId,
                        success: function (res) {
                        	if(res.data.STATUS == 1){
                        		var brokerInfo = res.data.DATA;
                        		that.setData({agentCont:true,archiveId:that.data.shareArchiveId,currUserMobile:brokerInfo.USER_MOBILE,currUserPhotoUrlPath:brokerInfo.USER_PHOTO,currUserName:brokerInfo.USER_NAME});
                        	}
                        }
                    })
                }
            },
             fail: function () {
                 //该房源已下架
            	 alert('该房源已下架');
             },complete:function(){
            	 that.setData({
                 loadingFlag:false,
    
                 });
             }
        })
    },
    onShareAppMessage: function () {
      var that = this;
      return {
        title: that.data.buildName,
        path: '/pages/houseDetail/houseDetail?caseId=' + that.data.caseId + "&caseType=" + that.data.caseType + "&cityId=" + that.data.cityId + "&reSource=" + that.data.reSource
      }
    },
    onReady: function () {
        // 页面渲染完成
      var that = this;
      var i = 0
      var ii = 0
      var animationCloudData = wx.createAnimation({
        duration: 800, // 默认为400     动画持续时间，单位ms
        timingFunction: 'ease-in-out',
      });
      //动画的脚本定义必须每次都重新生成，不能放在循环外
      animationCloudData.scale(1, 1).step({ duration: 800 }).scale(1.5, 1.5).step({ duration: 800 });

      // 更新数据
      that.setData({
        // 导出动画示例
        //animationData: animationData.export(),
        animationCloudData: animationCloudData.export(),
      })

      setInterval(function () {
        //动画的脚本定义必须每次都重新生成，不能放在循环外
        animationCloudData.scale(1.2, 1.2).step({ duration: 800 }).scale(0.8, 0.8).step({ duration: 800 });

        // 更新数据
        that.setData({
          // 导出动画示例
          //animationData: animationData.export(),
          animationCloudData: animationCloudData.export(),
        })
        ++ii;
      }.bind(that), 1500);//3000这里的设置如果小于动画step的持续时间的话会导致执行一半后出错
    },
    /*vr点击跳转*/
    vrBtnTo: function (e) {
    	var url = '/pages/vr/vr?caseId='+this.data.caseId+"&caseType="+this.data.caseType+"&cityId="+this.data.cityId;
	    if(this.data.shareArchiveId > 0){
	    	url += "&ARCHIVE_ID="+this.data.shareArchiveId;
		}
        wx.navigateTo({
        	url: url
        })
    },
    onShow: function () {},
    onHide: function () {},
    errImg: function (ev) {
        //需要访问当前页面的数据对象传递到其它页面上
        var _that = this;
        common.errImgFun(ev, _that, 'avatar');
    },
    changePic: function (e) {
        var current = e.detail.current;
        this.setData({
            currentPic: current + 1
        });
    },
    /**
     * 播放视频
     */
    playVideo: function () {
        var that = this;
        that.setData({
            videoShow: true,
            boxShow: false
        })
        setTimeout(function () {//视频延迟加载
            that.setData({
                videoShowLater: true,
                autoplay:true
            })
        }, 500)
    },
    closeBtn: function () {//关闭视频
        this.setData({
            videoShow: false,
            boxShow: true
        })
    },
    moreBtn: function () {//点击查看更多
        var that = this,
            showss = !that.data.showmor,
            showtt = !that.data.showtitle,
            closess = !that.data.closepic;
        that.setData({
            showmor: showss,
            showtitle: showtt,
            closepic: closess
            // btnHiden:false
        })
    },
    closeBtn: function () {//关闭视频
        this.setData({
            videoShow: false,
            boxShow: true
        })
    },
    moreBtn: function () {//点击查看更多
        var that = this,
            showss = !that.data.showmor,
            showtt = !that.data.showtitle,
            closess = !that.data.closepic;
        that.setData({
            showmor: showss,
            showtitle: showtt,
            closepic: closess
            // btnHiden:false
        })
    },
    moreZbBtn: function () {//周边信息点击查看更多
        var that = this,
            zbShowss = !that.data.showmorZb,
            zbShowtt = !that.data.showtitleZb,
            zbClosess = !that.data.zbClosepic;
        that.setData({
            showmorZb: zbShowss,
            showtitleZb: zbShowtt,
            zbClosepic: zbClosess
            // btnHiden:false
        })
    },
    /*
    *小区信息查看更多
    */
    houseMoreBtn: function () {
        var that = this,
            houseshowtt = !that.data.houseShowTitle,
            closess = !that.data.closeCont;
        that.setData({
            houseShowTitle: houseshowtt,
            closeCont: closess
        })
    },
    /*
    *五角星收藏控制
    */
    starBtn: function () {//点击查看更多
        app.checkLogin();//登录验证
        var that = this,v = !that.data.isCollected;
        that.setData({
        	isCollected: v
        })
         wx.request({
            url: app.buildRequestUrl('addOrDeleteCollectUrl') + "?caseId=" + that.data.caseId + "&caseType=" + that.data.caseType + "&cityId=" + that.data.cityId + "&reSource=" + that.data.reSource+"&userId="+app.globalData.userId,
            success: function (res) {
                var status = res.data.STATUS;
                that.setData({
                  collectToast:true,
                  collectTxt: res.data.INFO
                })
                setTimeout(function () {
                  that.setData({
                    collectToast:false
                  })
                }, 2000)
                if(status==0){
                	v = !that.data.isCollected;
                	that.setData({
                		isCollected: v
                	})
//                	alert("操作太频繁啦");
                }
            }
        })
    },
    /** 
     * 图片全屏预览
     */
    getImageInfo: function (e) {
        var that = this;
        var currentImage = e.currentTarget.dataset.image;
        var imageArr = that.data.picUrl;

        wx.previewImage({
            current: currentImage,// 当前显示图片的http链接
            urls: imageArr // 需要预览的图片http链接列表
        })
    },
    /** 
     * 房价评估跳转
     */
    calculator: function (e) {//房贷计算器跳转
        var that = this;
        var buildName = that.data.buildName;
        var houseRoom = that.data.houseRoom;
        var houseHall = that.data.houseHall;
        var houseWei = that.data.houseWei;
        var area = that.data.houseArea;
        var houseWhere = that.data.houseDirectCn;
        var floor = "";
        var toatleFloor = that.data.houseFloors;
        if (that.data.houseFloor=="低楼层"){
          floor = parseInt(toatleFloor/2) - 1;
        }else if (that.data.houseFloor == "中楼层"){
          floor = parseInt(toatleFloor / 2);
        } else if (that.data.houseFloor == "高楼层"){
          floor = parseInt(toatleFloor / 2) + 1;
        }else{
          floor = that.data.houseFloor
        }
        var url = '/pages/evaluationEntry/evaluationEntry?buildName=' + buildName + '&buildId=' + that.data.buildId + '&houseRoom=' + houseRoom + '&houseHall=' + houseHall + '&houseWei=' + houseWei + '&area=' + area + '&houseWhere=' + houseWhere + '&floor=' + floor + '&totalFloor=' + toatleFloor + '&houseType=' + that.data.houseUseage + '&whereFrom=detail';
        wx.navigateTo({
            url: url
        })
    },
  /**
   * 调整地图页
   */
    goToMap(e) {
      var lat = e.currentTarget.dataset.lat;
      var lng = e.currentTarget.dataset.lng;
      var type = e.currentTarget.dataset.type;
      var buildname = e.currentTarget.dataset.buildname;
      if (!!type) {
        wx.navigateTo({
          url: "../map/map?lat=" + lat + "&long=" + lng + "&type=" + type + '&buildname=' + buildname
        });
      } else {
        wx.navigateTo({
          url: "../map/map?lat=" + lat + "&long=" + lng + '&buildname=' + buildname
        });
      };
    },
    d: function (info, item, setValue) {//处理数据的
    	if(!!setValue){
    		myJson[item] = setValue;
    	}else if(!!info[item]){
    		myJson[item] = info[item];
    	}
    }
    ,dial:function(e){//拨打电话
      var _this = this;
    	var yezhu = e.currentTarget.dataset.yezhu;
      var _imid = e.currentTarget.dataset.imid;
    	var hezu = e.currentTarget.dataset.hezu;
    	if(yezhu==1 && hezu==1){//合租直接拨打
	       if (_this.data.isDecrypt == 1) {
	            wx.request({
	              url: 'https://uuhf.haofang.net/uuhfWeb/othenBiz/otherBizController/getAesEncrypt?type=decrypt&content=' + e.currentTarget.dataset.mobile,
	              success: function (res) {
	                var status = res.data.STATUS;
	                if (status == 1) {
	                  var phoneNum = res.data.DATA;
	                  if (tool.isIOS()) {
	                    wx.makePhoneCall({
	                      phoneNumber: phoneNum
	                    });
	                  } else {
	                    wx.showModal({
	                      title: '拨打电话',
	                      content: phoneNum.replace(',', ' 转 '),
	                      success: function (res) {
	                        if (res.confirm) {
	                          wx.makePhoneCall({
	                            phoneNumber: phoneNum
	                          });
	                        };
	                      }
	                    });
	                  };
	                }
	              }, complete: function () { app.hideToast(); }
	            })
	          }else{
	        	  wx.makePhoneCall({
	      			phoneNumber: e.currentTarget.dataset.mobile
	      		});
	          }
    		
    	}else if(yezhu==1){//整租和出售拨打400
    		//业主电话
    		var mobile = e.currentTarget.dataset.mobile;
        if (!!mobile){
          app.showToast('加载中');
          if (_this.data.is400Mobile == 1) {
            wx.request({
              url: 'https://uuhf.haofang.net/uuhfWeb/othenBiz/otherBizController/getAesEncrypt?type=decrypt&content=' + mobile,
              success: function (res) {
                var status = res.data.STATUS;
                if (status == 1) {
                  var phoneNum = res.data.DATA;
                  if (tool.isIOS()) {
                    wx.makePhoneCall({
                      phoneNumber: phoneNum
                    });
                  } else {
                    wx.showModal({
                      title: '拨打电话',
                      content: phoneNum.replace(',', ' 转 '),
                      success: function (res) {
                        if (res.confirm) {
                          wx.makePhoneCall({
                            phoneNumber: phoneNum
                          });
                        };
                      }
                    });
                  };
                }
              }, complete: function () { app.hideToast(); }
            })
          } else {
            wx.request({
              url: app.buildRequestUrl('getHouse400Phone'),
              data: {
                resource: this.data.reSource,
                cityId: this.data.cityId,
                mobilePhone: mobile,
              },
              success: function (res) {
                var phoneNum = res.data.DATA.currUser400Mobile;
                app.hideToast();
                if (res.data.STATUS == 1) {
                  _this.setData({
                    toastMask: false,
                    guideToast: false,
                    toastMask: false
                  });
                  if (tool.isIOS()) {
                    wx.makePhoneCall({
                      phoneNumber: phoneNum
                    });
                  } else {
                    wx.showModal({
                      title: '拨打电话',
                      content: phoneNum.replace(',', ' 转 '),
                      success: function (res) {
                        if (res.confirm) {
                          wx.makePhoneCall({
                            phoneNumber: phoneNum
                          });
                        };
                      }
                    });
                  };
                };
              }
            })
          }
        }else{
          if (!!_imid) {
        	  if(yezhu==1){
        		  wx.navigateTo({
        			  url: "/pages/im/im?to=" + _imid + "&caseId=" + _this.data.caseId + "&caseType=" + this.data.caseType+"&resource="+_this.data.resource
        		  })
        	  }else{
        		  wx.navigateTo({
        			  url: "/pages/im/im?to=" + _imid + "&caseId=" + _this.data.caseId + "&caseType=" + this.data.caseType
        		  })
        	  }
          }
        }
    	}else{
    		this.setData({toastMask:false,
    			guideToast: false,
    			toastMask:false
    		});
    		wx.makePhoneCall({
    			phoneNumber: e.currentTarget.dataset.mobile
    		});
    	}
    },
    houseDetail:function(e){//跳转到其他房源详情页
    	wx.redirectTo({
		  url: e.currentTarget.dataset.url
		})
    },
     /** 
     * 小区专家咨询点击
     */
    zjAgentChat:function(){
        this.setData({
          discountStatus:true
        })
    },
    /** 
     * 折扣弹框隐藏
     */
    diCloseBtn:function(){
      this.setData({
        discountStatus: false
      })
    },
    /** 
     * 我要买房点击跳转
     */
    goToBuyHouseBtn:function(e){
      var _this = this;
      if (this.data.locateCityId != this.data.cityId) {
        this.setData({
          toastHide: false
        });
        return;
      }
      var myset = e.currentTarget.dataset;
      var caseType = "";
      if (_this.data.caseType == 1) {
        caseType = 3;
      } else {
        caseType = 4;
      }
      wx.navigateTo({
		  url: '/pages/entrust/entrust?archiveId=' + myset.buildownerarchiveid + '&isVip=1' + '&userMobile=' + myset.buildownermobile + '&userName=' + myset.buildownername
		  + '&rentMoney=' + myset.rentmoney + '&buyMoney=' + myset.buymoney + '&serviceRegs=' + myset.serviceregs + '&userPhoto=' + myset.buildownerpicurl + '&caseType=' + caseType,
	  })
    },
    /** 
     * 我要出租，出售点击跳转
     */
    goToEntrustLiBtn:function(e){
      var _this = this;
      if (this.data.locateCityId != this.data.cityId) {
        this.setData({
          toastHide: false
        });
        return;
      }
      var _buildOwnerArchiveId = e.currentTarget.dataset.buildownerarchiveid;
      var goToUrl="";
      if (_this.data.caseType == 1) {
        goToUrl = 'sale';
      } else {
        goToUrl = 'rent';
      }
      wx.navigateTo({
		  url: "/pages/saleRegistration/"+goToUrl+"Registration?archiveId=" + e.currentTarget.dataset.buildownerarchiveid + "&isVip=1"
	  })      
    },
    /** 
     * 弹框蒙层点击隐藏
     */
    maskHideBtn:function(){
        this.setData({
          toastMask:false,
          communityToast:false
        })
    },
    /** 
     * 房源下架弹框确定点击
     */
    outedHouseBtn:function(){
      wx.navigateTo({
        url: '',
      })
      this.setData({
        toastMask: false
      })
    },
    /** 
     * 联系方式在线聊天点击
     */
    onlineChat:function(e){
      var _this = this;
      _this.setData({
        toastMask:false
      })
      if (!app.globalData.userId || app.globalData.userId == undefined){
        app.saveUserData(function(res){
          wx.navigateTo({
            url: "/pages/im/im?to=" + e.currentTarget.dataset.archive + "&caseId=" + _this.data.caseId + "&caseType=" + _this.data.caseType + "&reSource=" + _this.data.reSource
          })
        })
      }else{
        wx.navigateTo({
          url: "/pages/im/im?to=" + e.currentTarget.dataset.archive + "&caseId=" + _this.data.caseId + "&caseType=" + _this.data.caseType+"&reSource=" + _this.data.reSource
        })
      }
    	
    },
    downBtn: function (e) {
      this.setData({
        toastMask:true,
        sealedHouse: false,
        guideToast: false,
        leadToast: true,
      })
    },
    chooseContactType:function(e){
      var _this = this;
      if (!app.globalData.userId || app.globalData.userId == undefined || app.globalData.userId == null) {
        app.saveUserData(function (res) {
          wx.navigateTo({
            url: "/pages/im/im?to=" + e.currentTarget.dataset.archive + "&caseId=" + _this.data.caseId + "&caseType=" + _this.data.caseType
          })
        })
      } else {
        wx.navigateTo({
          url: "/pages/im/im?to=" + e.currentTarget.dataset.archive + "&caseId=" + _this.data.caseId + "&caseType=" + _this.data.caseType
        })
      }
    },
    /*引导下载板块点击*/
    goToDownLoad: function () {
      wx.navigateTo({
        url: "../download/download",
      })
    },
    /** 
     * 拒绝看房
     */
    disagreen4Daikan:function(){
    	var that = this;
	  	  wx.request({
	  		  url: app.buildRequestUrl('disagreen4Daikan'),
	  		  data:{
	  			recomInfoId:that.data.recomInfoId,
	        	isVip:that.data.isVip,
	  		  },
	  		  success: function (res) {
	  			  var status = res.data.STATUS;
	  			  if(status==1){
	  				  that.setData({noSeeConfirmBox:false});
	  		        	wx.showToast({
	  	      			  title: '操作成功',
	  	      			  icon: 'success',
	  	      			  duration: 1500,
	  	      			  success:function(){
	  	      				  wx.redirectTo({
	  	      					  url:'/pages/entrustDetail/entrustDetail?pushLogId='+that.data.pushLogId
	  	      				  });
	  	      			  }
	  	      			});
	  	        	}else{
	  	        		wx.showToast({
	  	        			title: '未知错误',
	  	  				  image:'../../images/warning.png',
	  	  				  duration: 1500,
	  	  				  success:function(){
	  	  	  			  }
	  	  				});
	  	        	}
	  		  }
	  	  })
    },
    /** 
     * 同意看房
     */
    agreen4Daikan: function () {
    	var that = this;
	    wx.request({
	        url: app.buildRequestUrl('agreen4Daikan'),
	        data:{
	        	recomInfoId:that.data.recomInfoId,
	        	userId:that.data.userId,
	        	isVip:that.data.isVip,
	        },
	        success: function (res) {
	        	var status = res.data.STATUS;
	        	if(status==1){
	        		wx.showToast({
        			  title: '操作成功',
        			  icon: 'success',
        			  duration: 1500,
        			  success:function(){
  	      				  wx.redirectTo({
  	      					  url:'/pages/entrustDetail/entrustDetail?pushLogId='+that.data.pushLogId
  	      				  });
  	      			  }
        			});
	        	}else{
	        		wx.showToast({
  	  				  title: '未知错误',
  	  				  image:'../../images/warning.png',
  	  				  duration: 1500,
  	  				  success:function(){
  	  	  			  }
  	  				});
	        	}
	        }
	    })
    },
    serviceBtn: function () {},
    /**
     * 群发委托
     */
    goToEntrust: function (e) {
      let _this = this;
      if (_this.data.backToIndexBtn === true) {
        wx.switchTab({
          url: '/pages/real_index/index'
        })
      }
      if (this.data.locateCityId != this.data.cityId) {
        this.setData({
          toastHide: false
        });
        return;
      }
      var that = this,
          caseType,
          wfRelateId,
          resource,
          houseRegion,
          houseSection,
          regionName,
          sectionName,
          houseUseage,
          houseUseageCn,
          houseFitment,
          houseFitmentCn,
          houseRoom,
          houseHall,
          houseWei,
          buildName,
          houseTotalPrice,
          houseArea;

      
      if (that.data.caseType == 1) {
        caseType = 3;
      } else {
        caseType = 4;
      }

      wfRelateId = that.data.caseId;
      resource = that.data.reSource;
      houseRegion = that.data.buildRegionId;
      houseSection = that.data.sectionId;
      regionName = that.data.regionName;
      sectionName = that.data.sectionName;
      houseUseage = that.data.houseUseage;
      houseUseageCn = that.data.houseUseageCn;
      houseFitment = that.data.houseFitment;
      houseFitmentCn = that.data.houseFitmentCn;
      houseRoom = that.data.houseRoom;
      houseHall = that.data.houseHall;
      houseWei = that.data.houseWei;
      buildName = that.data.buildName;
      houseTotalPrice = that.data.houseTotalPrice;
      houseArea = that.data.houseArea;;

      wx.navigateTo({
        url: '/pages/entrust/entrust?caseType=' + caseType + '&specialOper=1&wfRelateId=' + wfRelateId + '&resource=' + resource + '&houseRegion=' + houseRegion + '&houseSection=' + houseSection + '&regionName=' + regionName + '&sectionName=' + sectionName + '&houseUseage=' + houseUseage + '&houseUseageCn=' + houseUseageCn + '&houseFitment=' + houseFitment + '&houseFitmentCn=' + houseFitmentCn + '&houseRoom=' + houseRoom + '&houseTotalPrice=' + houseTotalPrice + '&houseArea=' + houseArea
        + '&houseHall=' + houseHall + '&houseWei=' + houseWei + '&buildName=' + buildName
      })
    },
    guideBackHome:function(e){
      let _this = this;
 
      let formId = e.detail.formId;
      let openId = wx.getStorageSync('openId');
      let userInfo = wx.getStorageSync('userInfo');
      let cacheKey = app.globalData.userId + '_' + 'houseDetail';
      if (api.getStorageData(cacheKey)) {
        _this.setData({
          guideBackIndex: false
        });
        console.log('上次点击还在有效时间内');
        return false;
      }
      //发送模板消息
      wx.request({
        url: app.buildRequestUrl('collectFormIdUrl'),
        // url:'http://lbuuweb.hftsoft.com/Mini/App/collectFormId',
        data: {
          formId: formId,
          userId: app.globalData.userId,
          openId: openId,
          formType: 1
        },
        header: {
          'content-type': 'application/json' // 默认值
        },
        success: function (res) {
          //缓存一天
          api.setStorageData(cacheKey, true, 86400);
        },
        complete: function(){
          _this.setData({
            guideBackIndex: false
          });
        }
      })
    },
    /**
     * 新房详情跳转
     */
    goToNewHouseDetail:function(e){
      var that = this;
      var _uid = e.currentTarget.dataset.uid;
      wx.navigateTo({
        url: '/pages/newHouseDetail/newHouseDetail?buildid=' + _uid,
      })
    },
    /**
     * 房价评估接口
     */
    requstEvaluate:function(e){
      var _this=this;
      var data={
        cityId:_this.data.cityId,
        buildId:_this.data.buildId,
      };
      wx.request({
        url:app.buildRequestUrl('getPriceTrendNew'),
        data:data,
        success:function(res){
          if(res.data.STATUS==1){
              var data=res.data.DATA;
              if(data){
                var ratioByLastYearForPrice=parseFloat(Math.abs(data.ratioByLastYearForPrice*100)).toFixed(2);
                var ratioByLastMonthForPrice=parseFloat(Math.abs(data.ratioByLastMonthForPrice*100)).toFixed(2);
                _this.setData({
                  evaluateValue:data,
                  ratioByLastYearForPrice:ratioByLastYearForPrice,
                  ratioByLastMonthForPrice:ratioByLastMonthForPrice
                })
              }
          }
        }
      })
    },
    /**
     * 去评估页面
     */
    goEvaluateEvent:function(e){
      var _this=this,data=_this.data,houseType;
      if(data.houseUseageCn=='住宅'||!data.houseUseageCn){
        houseType=1;
      }else if(data.houseUseageCn=='别墅'){
        houseType=2;
      }
      wx.navigateTo({
        url:'/pages/priceTrend/priceTrend?cityId='+_this.data.cityId+'&buildId='+_this.data.buildId+'&houseType='+houseType,
      })
    },
    /**
     * 挂牌经纪人联系
     */
    gpCallBtn:function(e){
      var that = this;
      var phoneN = e.currentTarget.dataset.mobile;
      if (!!phoneN){
        wx.request({
        	  		  url: app.buildRequestUrl('getHouse400Phone'),
        	  		  data:{
        	  			resource:this.data.reSource,
        	  			cityId:this.data.cityId,
        	  			mobilePhone:phoneN,
        	  		  },
        	  		  success: function (res) {
                    var phoneNum = res.data.DATA.currUser400Mobile;
        	  			  app.hideToast();
        	  			  if(res.data.STATUS==1){
        	  				that.setData({toastMask:false,
                        guideToast: false,
                        toastMask:false
                      });
        	  			if(tool.isIOS()){
                        wx.makePhoneCall({
                          phoneNumber: phoneNum
                        });
                      }else{
                        wx.showModal({
                          title: '拨打电话',
                          content: phoneNum.replace(',',' 转 '),
                          success: function (res) {
                            if (res.confirm) {
                              wx.makePhoneCall({
                                phoneNumber: phoneNum
                              });
                            };
                          }
                        });
                      };
        	  			  };
        	  		  }
        	  	  })
      }else{
        that.setData({
          collectToast:true,
          collectTxt: "无号码或号码错误！"
        })
        setTimeout(function () {
          that.setData({
            collectToast: false
          })
        }, 2000)
      }
    },
    /**
     * 隐藏引导下载
     */
    orderClose:function(e){
      var _this=this;
      _this.setData({
        leadToast:false,
        toastMask:false,
        guideToast:false,
        communityToast:false,
      })
    },
    /**
     * 小区专家
     */
    xiaoquCallEvent:function(e){
      var _this=this;
      _this.setData({
        toastMask:true,
        communityToast:true,
        guideToast:false,
         leadToast:false,
      })
    },
    /**
     *tab导航点击 
     */
    tabBtnCheck(e) {
      var that = this;
      var _t = e.currentTarget.dataset.shows;
      if (_t == 's') {
        that.setData({
          showFlas: false,
          offFlag: true,
        })
        var animation = wx.createAnimation({
          duration: 1000,
          timingFunction: "ease",
        })
        this.animation = animation

        animation.translateX(-195).step();

        this.setData({
          animationData: animation.export()
        })
      } else {
        that.setData({
          showFlas: true,
          offFlag: false,
        })
        var animation = wx.createAnimation({
          duration: 1000,
          timingFunction: "ease",
        })
        this.animation = animation

        animation.translateX(0).step();

        this.setData({
          animationData: animation.export()
        })
      }

    },
    /**
   *点击导航遮罩层 
   */
    offToast: function () {
      var that = this;
      that.setData({
        showFlas: true,
        offFlag: false,
      })
      var animation = wx.createAnimation({
        duration: 1000,
        timingFunction: "ease",
      })
      this.animation = animation

      animation.translateX(0).step();

      this.setData({
        animationData: animation.export()
      })
    },
    /**
     * 隐号拨打
     */
    yinhao:function(e){
      var _this=this;
      _this.setData({
        communityToast:false,
        yezhuContactFlag:false,
        leadToast:true
      })
    },
    /** 
     * 联系方式在线聊天点击
     */
    onlineChat4C:function(e){
    	var imid = e.currentTarget.dataset.imid;
    	if(!!imid){
    		imid = imid.replace("uu_","");
    	}
      var _this = this;
      _this.setData({
        toastMask:false
      })
    	wx.navigateTo({
            url: "/pages/im/imc?from="+_this.data.userId+"&to="+imid+"&caseId="+this.data.caseId+"&caseType="+this.data.caseType
        })
    },
    goToFenQi:function(e){
    	wx.navigateTo({
            url: "/pages/fenqi/fenqi?mobile="+e.currentTarget.dataset.mobile
        })
    },
    iHaveKnowItPullOff(){
      wx.reLaunch({
        url: '/pages/real_index/index'
      });
    },
    //点击假一赔百的活动banner
    actBanner(e){
      
      
    },
    formSubmit(e){
        let _this = this;
        let str = _this.data.buildName + ' ' + _this.data.houseRoom + '室' + _this.data.houseHall + '厅' + _this.data.houseWei + '卫' + ' ' + _this.data.houseArea + '㎡' + ' ' + _this.data.houseTotalPrice + _this.data.priceUnitCn;
        //跳转到规则页
        wx.navigateTo({
          url: '/pages/fakeHouse/fakeHouse?archiveId=' + _this.data.archiveId + '&caseType=' + _this.data.caseType + '&caseId=' + _this.data.caseId + '&houseInfo=' + str,
      })
    }
})